name: Deploy site App

on:
  push:
    branches: [ master ]
  workflow_dispatch:    # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€

jobs:
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci --only=production
        npm cache clean --force
        
    - name: Run tests
      run: |
        npm install --only=dev
        npm test
      env:
        NODE_ENV: test
        
    - name: Run security audit
      run: |
        npm audit --audit-level moderate || true
        
  deploy:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'
        
    - name: Deploy to server and pull changes
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          set -e  # ĞŸÑ€ĞµÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
          set -o pipefail  # ĞŸÑ€ĞµÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Ğ² pipe
          
          echo "ğŸš€ Starting deployment process..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          if [ ! -d "/var/www/site" ]; then
            echo "âŒ Error: Directory /var/www/site does not exist"
            exit 1
          fi
          
          echo "ğŸ“ Switching to project directory..."
          cd /var/www/site || {
            echo "âŒ Failed to change directory to /var/www/site"
            exit 1
          }
          
          echo "ğŸ” Current directory: $(pwd)"
          echo "ğŸ‘¤ Running as user: $(whoami)"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
          if [ ! -w "." ]; then
            echo "âŒ Error: No write permissions in current directory"
            exit 1
          fi
          
          echo "ğŸ”„ Resetting any local changes..."
          git reset --hard HEAD || {
            echo "âš ï¸  Git reset failed, continuing..."
          }
          
          echo "ğŸ§¹ Cleaning untracked files..."
          git clean -fd || {
            echo "âš ï¸  Git clean failed, continuing..."
          }
          
          echo "ğŸ“¥ Pulling latest changes from Git..."
          git fetch origin || {
            echo "âŒ Git fetch failed"
            exit 1
          }
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²ĞµÑ‚ĞºĞ¸
          if ! git show-ref --verify --quiet refs/remotes/origin/master; then
            echo "âŒ Error: Branch master does not exist in remote"
            exit 1
          fi
          
          echo "ğŸ”„ Switching to master branch..."
          git checkout master --force || {
            echo "âŒ Git checkout failed"
            exit 1
          }
          
          echo "ğŸ“¥ Pulling changes..."
          git pull origin master --force || {
            echo "âŒ Git pull failed"
            exit 1
          }
          
          echo "âœ… Git operations completed successfully"
          echo "ğŸ“¦ Installing dependencies..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ package.json
          if [ ! -f "package.json" ]; then
            echo "âŒ Error: package.json not found"
            exit 1
          fi
          
          npm install || {
            echo "âŒ npm install failed"
            exit 1
          }
          
          echo "âœ… Dependencies installed successfully"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ package-lock.json Ğ´Ğ»Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ°
          if [ -f "package-lock.json" ]; then
            echo "ğŸ”’ Running npm audit..."
            npm audit --audit-level moderate || {
              echo "âš ï¸  npm audit found vulnerabilities"
              # ĞĞµ Ğ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´Ğ°ĞµĞ¼
            }
          fi

           # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ PM2)
          if command -v pm2 &> /dev/null; then
            echo "ğŸ”„ Restarting application with PM2..."
            pm2 restart all || {
              echo "âŒ PM2 restart failed"
              exit 1
            }
            echo "âœ… Application restarted with PM2"
          else
            echo "â„¹ï¸  PM2 not found, manual restart required"
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ°
          if command -v ss &> /dev/null; then
            echo "ğŸ” Checking if application is running..."
            if sudo ss -tuln | grep ':3000' > /dev/null; then
              echo "âœ… Application is running on port 3000"
            else
              echo "âš ï¸  Application may not be running on expected port"
            fi
          elif command -v netstat &> /dev/null; then
            echo "ğŸ” Checking if application is running..."
            if sudo netstat -tuln | grep ':3000' > /dev/null; then
              echo "âœ… Application is running on port 3000"
            else
              echo "âš ï¸  Application may not be running on expected port"
            fi
          else
            echo "âŒ Neither ss nor netstat is available"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Deployment info:"
          echo "   Branch: $(git branch --show-current)"
          echo "   Commit: $(git log -1 --oneline)"
          echo "   Date: $(date)"