name: Auto Create PR on Push

on:
  push:
    branches:
      - 'release'

jobs:
  check-existing-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_exists: ${{ steps.check.outputs.pr_exists }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ GitHub CLI –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          if ! command -v gh &> /dev/null; then
            type -p curl >/dev/null || sudo apt-get update && sudo apt-get install curl -y
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update && sudo apt-get install gh -y
          fi
          
          # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è GitHub CLI
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Check for existing PR
        id: check
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤–µ—Ç–∫–∏
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Checking PR for branch: $BRANCH_NAME"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ PR —á–µ—Ä–µ–∑ API (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
          PR_JSON=$(gh api \
            -H "Accept: application/vnd.github.v3+json" \
            "/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH_NAME&state=open" \
            --jq '.[0]')
          
          if [ "$PR_JSON" != "null" ] && [ -n "$PR_JSON" ]; then
            PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')
            if [ -n "$PR_NUMBER" ]; then
              echo "PR already exists for branch $BRANCH_NAME"
              echo "PR number: $PR_NUMBER"
              echo "pr_exists=true" >> $GITHUB_OUTPUT
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "No existing PR found for branch $BRANCH_NAME"
              echo "pr_exists=false" >> $GITHUB_OUTPUT
              echo "pr_number=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "No existing PR found for branch $BRANCH_NAME"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "pr_number=0" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'false'
    steps:
      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "master"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "Release PR: ${{ github.ref_name }}"
          pr_body: |
            ## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Release PR
            
            **–í–µ—Ç–∫–∞:** ${{ github.ref_name }}
            **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
            **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
            **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
            
            **–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
            ```
            ${{ github.event.head_commit.message }}
            ```
            
            ---
            *–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É release*
          pr_label: "release,auto-pr"
          pr_draft: false

  update-existing-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'true'
    steps:
      - name: Setup GitHub CLI
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è GitHub CLI
          if ! command -v gh &> /dev/null; then
            type -p curl >/dev/null || sudo apt-get update && sudo apt-get install curl -y
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update && sudo apt-get install gh -y
          fi
          
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Update existing PR
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          PR_NUMBER="${{ needs.check-existing-pr.outputs.pr_number }}"
          
          echo "PR #$PR_NUMBER already exists for $BRANCH_NAME"
          echo "Last commit: ${{ github.event.head_commit.message }}"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
          COMMENT_BODY="üìù **–ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≤–µ—Ç–∫—É release:**
          
          **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
          **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
          **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
          
          **–°–æ–æ–±—â–µ–Ω–∏–µ:**
          \`\`\`
          ${{ github.event.head_commit.message }}
          \`\`\`"
          
          echo "Adding comment to PR #$PR_NUMBER"
          echo "$COMMENT_BODY" | gh pr comment "$PR_NUMBER" --body-file -