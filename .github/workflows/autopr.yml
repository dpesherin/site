name: Auto Create PR on Push

on:
  push:
    branches:
      - 'release'

jobs:
  check-existing-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_exists: ${{ steps.check.outputs.pr_exists }}
    steps:
      - name: Check for existing PR
        id: check
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–π PR –¥–ª—è —ç—Ç–æ–π –≤–µ—Ç–∫–∏
          pr_list=$(gh pr list --head "${{ github.ref_name }}" --state open --json number --jq length)
          if [ "$pr_list" -gt 0 ]; then
            echo "PR already exists for branch ${{ github.ref_name }}"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found for branch ${{ github.ref_name }}"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "master"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "Auto PR: ${{ github.ref_name }}"
          pr_body: |
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π PR –∏–∑ ${{ github.ref_name }}
            
            –°–æ–∑–¥–∞–Ω–æ: ${{ github.event.head_commit.timestamp }}
            –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.id }}
            –ê–≤—Ç–æ—Ä: ${{ github.event.head_commit.author.name }}
          pr_label: "auto-pr"
          pr_draft: false
          pr_assignee: ""  # –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏–Ω
          pr_reviewer: ""  # –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

  update-existing-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'true'
    steps:
      - name: Update existing PR
        run: |
          echo "PR already exists for ${{ github.ref_name }}. Skipping creation."
          echo "Last commit: ${{ github.event.head_commit.message }}"
          # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
          pr_number=$(gh pr list --head "${{ github.ref_name }}" --state open --json number --jq '.[0].number')
          gh pr comment $pr_number --body "üìù –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${{ github.event.head_commit.message }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}