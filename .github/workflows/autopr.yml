name: Auto Create PR on Push

on:
  push:
    branches:
      - 'release'

jobs:
  check-existing-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_exists: ${{ steps.check.outputs.pr_exists }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å git

      - name: Setup GitHub CLI
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ GitHub CLI
          type -p curl >/dev/null || sudo apt-get update && sudo apt-get install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install gh -y
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è GitHub CLI
          gh auth setup-git --hostname github.com

      - name: Check for existing PR
        id: check
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤–µ—Ç–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ GitHub
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Checking PR for branch: $BRANCH_NAME"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–π PR –¥–ª—è —ç—Ç–æ–π –≤–µ—Ç–∫–∏
          PR_DATA=$(gh pr list --head "$BRANCH_NAME" --state open --json number,title || echo "[]")
          PR_COUNT=$(echo "$PR_DATA" | jq 'length')
          
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "PR already exists for branch $BRANCH_NAME"
            PR_NUM=$(echo "$PR_DATA" | jq '.[0].number')
            echo "PR number: $PR_NUM"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found for branch $BRANCH_NAME"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "pr_number=0" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'false'
    steps:
      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "master"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "Release PR: ${{ github.ref_name }}"
          pr_body: |
            ## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Release PR
            
            **–í–µ—Ç–∫–∞:** ${{ github.ref_name }}
            **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
            **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
            **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
            
            **–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
            ```
            ${{ github.event.head_commit.message }}
            ```
            
            ---
            *–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É release*
          pr_label: "release,auto-pr"
          pr_draft: false
          pr_assignee: ""
          pr_reviewer: ""
          pr_milestone: ""
          pr_template: ""

  update-existing-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt-get update && sudo apt-get install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install gh -y

      - name: Update existing PR
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "PR already exists for $BRANCH_NAME. Skipping creation."
          echo "Last commit: ${{ github.event.head_commit.message }}"
          
          # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ PR
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')
          echo "PR number: $PR_NUMBER"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            COMMENT_BODY="üìù **–ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≤–µ—Ç–∫—É release:**
            
            **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
            **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
            **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
            
            **–°–æ–æ–±—â–µ–Ω–∏–µ:**
            \`\`\`
            ${{ github.event.head_commit.message }}
            \`\`\`"
            
            echo "Adding comment to PR #$PR_NUMBER"
            echo "$COMMENT_BODY" | gh pr comment "$PR_NUMBER" --body-file -
          else
            echo "Could not find PR number for branch $BRANCH_NAME"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}