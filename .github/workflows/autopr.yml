name: Auto Create PR on Push

on:
  push:
    branches:
      - 'release'

jobs:
  check-existing-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      pr_exists: ${{ steps.check.outputs.pr_exists }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for existing PR via API
        id: check
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤–µ—Ç–∫–∏
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Checking PR for branch: $BRANCH_NAME"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö PR
          RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH_NAME&state=open")
          
          # –û—Ç–ª–∞–¥–∫–∞
          echo "API Response: $RESPONSE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
          PR_COUNT=$(echo "$RESPONSE" | jq 'length')
          
          if [ "$PR_COUNT" -gt 0 ]; then
            PR_NUMBER=$(echo "$RESPONSE" | jq '.[0].number')
            echo "PR already exists for branch $BRANCH_NAME"
            echo "PR number: $PR_NUMBER"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found for branch $BRANCH_NAME"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "pr_number=0" >> $GITHUB_OUTPUT
          fi

  create-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: needs.check-existing-pr.outputs.pr_exists == 'false'
    steps:
      - name: Create Pull Request via API
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          # –°–æ–∑–¥–∞–µ–º PR —á–µ—Ä–µ–∑ GitHub API
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "{
              \"title\": \"Release PR: $BRANCH_NAME\",
              \"body\": \"## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Release PR\\n\\n**–í–µ—Ç–∫–∞:** $BRANCH_NAME\\n**–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})\\n**–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}\\n**–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}\\n\\n**–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**\\n\\\`\\\`\\\`\\n${{ github.event.head_commit.message }}\\n\\\`\\\`\\\`\\n\\n---\\n*–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É release*\",
              \"head\": \"$BRANCH_NAME\",
              \"base\": \"master\"
            }")
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          PR_URL=$(echo "$RESPONSE" | jq -r '.html_url // empty')
          if [ -n "$PR_URL" ]; then
            echo "‚úÖ Pull Request created successfully: $PR_URL"
            
            # –î–æ–±–∞–≤–ª—è–µ–º label
            PR_NUMBER=$(echo "$RESPONSE" | jq -r '.number')
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/labels" \
              -d '{"labels":["release", "auto-pr"]}'
          else
            echo "‚ùå Failed to create PR"
            echo "Response: $RESPONSE"
            exit 1
          fi

  update-existing-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    if: needs.check-existing-pr.outputs.pr_exists == 'true'
    steps:
      - name: Add comment to existing PR
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          PR_NUMBER="${{ needs.check-existing-pr.outputs.pr_number }}"
          
          echo "PR #$PR_NUMBER already exists for $BRANCH_NAME"
          echo "Last commit: ${{ github.event.head_commit.message }}"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
          COMMENT_BODY="üìù **–ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≤–µ—Ç–∫—É release:**
          
          **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
          **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
          **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
          
          **–°–æ–æ–±—â–µ–Ω–∏–µ:**
          \`\`\`
          ${{ github.event.head_commit.message }}
          \`\`\`"
          
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            -d "{\"body\": \"$COMMENT_BODY\"}"
          
          echo "‚úÖ Comment added to PR #$PR_NUMBER"