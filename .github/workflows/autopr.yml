name: Auto Create PR on Push

on:
  push:
    branches:
      - 'release'

env:
  GITHUB_TOKEN_PAT: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  check-existing-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_exists: ${{ steps.check-pr.outputs.pr_exists }}
      pr_number: ${{ steps.check-pr.outputs.pr_number }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for existing PR
        id: check-pr
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Checking PR for branch: $BRANCH_NAME"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö PR —á–µ—Ä–µ–∑ API
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls"
          
          response=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL?head=$REPO_OWNER:$BRANCH_NAME&state=open")
          
          echo "API Response: $response"
          
          # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
          if echo "$response" | jq -e '.[0]' > /dev/null 2>&1; then
            pr_num=$(echo "$response" | jq '.[0].number')
            echo "‚úÖ PR already exists: #$pr_num"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$pr_num" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è No existing PR found"
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "pr_number=0" >> $GITHUB_OUTPUT
          fi

  create-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'false'
    steps:
      - name: Create Pull Request
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ PR
          PR_BODY=$(cat << EOF
          ## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Release PR
          
          ### üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          - **–í–µ—Ç–∫–∞:** \`$BRANCH_NAME\`
          - **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
          - **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
          - **–î–∞—Ç–∞:** ${{ github.event.head_commit.timestamp }}
          
          ### üìù –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
          \`\`\`
          ${{ github.event.head_commit.message }}
          \`\`\`
          
          ---
          *–°–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É \`release\`*
          EOF
          )
          
          # JSON –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PR
          PR_DATA=$(cat << EOF
          {
            "title": "Release PR: $BRANCH_NAME",
            "body": $(echo "$PR_BODY" | jq -Rs .),
            "head": "$BRANCH_NAME",
            "base": "master",
            "maintainer_can_modify": true
          }
          EOF
          )
          
          echo "Creating PR with data: $PR_DATA"
          
          # –°–æ–∑–¥–∞–µ–º PR
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "$PR_DATA")
          
          # –†–∞–∑–¥–µ–ª—è–µ–º response –∏ HTTP –∫–æ–¥
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | sed '$d')
          
          echo "HTTP Code: $http_code"
          echo "Response: $response_body"
          
          if [ "$http_code" = "201" ]; then
            pr_url=$(echo "$response_body" | jq -r '.html_url')
            pr_number=$(echo "$response_body" | jq -r '.number')
            
            echo "‚úÖ Pull Request —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ: $pr_url"
            
            # –î–æ–±–∞–≤–ª—è–µ–º labels
            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$pr_number/labels" \
              -d '{"labels":["release", "auto-generated"]}'
            
            echo "‚úÖ Labels –¥–æ–±–∞–≤–ª–µ–Ω—ã"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PR"
            echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: $response_body"
            exit 1
          fi

  update-existing-pr:
    needs: check-existing-pr
    runs-on: ubuntu-latest
    if: needs.check-existing-pr.outputs.pr_exists == 'true'
    steps:
      - name: Update existing PR
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          PR_NUMBER="${{ needs.check-existing-pr.outputs.pr_number }}"
          
          echo "üìå –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR #$PR_NUMBER –¥–ª—è –≤–µ—Ç–∫–∏: $BRANCH_NAME"
          echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
          COMMENT_BODY=$(cat << EOF
          ### üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏ release
          
          –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ç–∫—É \`$BRANCH_NAME\`:
          
          **–ö–æ–º–º–∏—Ç:** [${{ github.event.head_commit.id }}](https://github.com/${{ github.repository }}/commit/${{ github.event.head_commit.id }})
          **–ê–≤—Ç–æ—Ä:** ${{ github.event.head_commit.author.name }}
          **–í—Ä–µ–º—è:** ${{ github.event.head_commit.timestamp }}
          
          **–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞:**
          \`\`\`
          ${{ github.event.head_commit.message }}
          \`\`\`
          
          ---
          *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*
          EOF
          )
          
          # JSON –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
          COMMENT_DATA=$(cat << EOF
          {
            "body": $(echo "$COMMENT_BODY" | jq -Rs .)
          }
          EOF
          )
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            -d "$COMMENT_DATA")
          
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "201" ]; then
            echo "‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ PR #$PR_NUMBER"
          else
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∫–æ–¥: $http_code)"
            echo "–û—Ç–≤–µ—Ç: $response_body"
          fi
          
          # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º PR (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤–µ—Ç–∫—É)
          echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–µ—Ç–∫–∏ PR..."
          curl -s -X PUT \
            -H "Authorization: token $GITHUB_TOKEN_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/update-branch"